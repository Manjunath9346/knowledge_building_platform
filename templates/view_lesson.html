{% extends "base.html" %}

{% block title %}Lesson: {{ lesson.title }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-12">

            <h1 class="section-title text-white mb-2">{{ lesson.title }}</h1>

            {% if lesson.course_id %}
                <p class="text-secondary">
                    Course:
                    <a href="{{ url_for('course_detail', course_id=lesson.course_id) }}" class="text-info">
                        {{ course_title }}
                    </a>
                </p>
            {% else %}
                <p class="text-secondary"><strong>Standalone Content</strong></p>
            {% endif %}

            <div class="glass-card p-4 mt-4">

                <h4 class="text-warning mb-3">Content Type: {{ lesson.content_type | upper }}</h4>

                {% set file_url = lesson.filename and url_for('media', filename=lesson.filename) %}

                {% if lesson.content_type == 'video' %}

                    <!-- ========== VIDEO PLAYER ========== -->
                    <video id="videoPlayer"
                           data-lesson-id="{{ lesson.id }}"
                           data-duration="{{ lesson.duration_seconds or '' }}"
                           data-progress="{{ user_progress['percent_complete'] if user_progress else 0 }}"
                           data-watched="{{ user_progress['watched_seconds'] if user_progress else 0 }}"
                           controls
                           class="w-100 rounded"
                           style="max-height: 600px;">
                        <source src="{{ file_url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>

                    {% if lesson.duration_seconds %}
                    <p class="text-secondary mt-2">
                        Duration:
                        {{ lesson.duration_seconds // 60 }}:
                        {% if (lesson.duration_seconds % 60) < 10 %}0{% endif %}
                        {{ lesson.duration_seconds % 60 }}
                    </p>
                    {% endif %}

                    <!-- ========== PROGRESS UI ========== -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-secondary">Your Progress</small>

                            <form method="POST" action="{{ url_for('progress_mark_complete') }}">
                                <input type="hidden" name="lesson_id" value="{{ lesson.id }}">
                                <button class="btn btn-sm btn-vibrant" type="submit">Mark Complete</button>
                            </form>
                        </div>

                        <div class="progress" style="height: 10px;">
                            <div id="progressBar"
                                 class="progress-bar"
                                 role="progressbar"
                                 style="width: 0%;">
                            </div>
                        </div>

                        <small id="progressText" class="text-secondary">0% completed</small>
                    </div>

                    <!-- ========== CLEAN JAVASCRIPT ==========
                         No Jinja inside JS â†’ No VS Code errors
                    -->
                    <script>
                        document.addEventListener("DOMContentLoaded", () => {
                            const video = document.getElementById("videoPlayer");
                            const progressBar = document.getElementById("progressBar");
                            const progressText = document.getElementById("progressText");

                            // Read safe values from HTML data attributes
                            const lessonId = parseInt(video.dataset.lessonId);
                            const duration = parseInt(video.dataset.duration) || null;
                            const initialPercent = parseFloat(video.dataset.progress) || 0;
                            const lastWatched = parseFloat(video.dataset.watched) || 0;

                            let lastSent = 0;
                            const interval = 8000;

                            // Initialize UI
                            function updateUI(p) {
                                progressBar.style.width = p + "%";
                                progressText.textContent = p.toFixed(1) + "% completed";
                                if (p >= 90) progressBar.classList.add("bg-success");
                            }

                            updateUI(initialPercent);

                            if (video && lastWatched > 2) {
                                try { video.currentTime = lastWatched; } catch {}
                            }

                            function sendProgress(sec) {
                                fetch("/progress/update", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({
                                        lesson_id: lessonId,
                                        watched_seconds: Math.floor(sec),
                                        duration_seconds: duration
                                    })
                                }).then(r => r.json()).then(res => {
                                    if (res.ok) updateUI(res.percent_complete);
                                });
                            }

                            video.addEventListener("timeupdate", () => {
                                if (!duration) return;
                                const p = (video.currentTime / duration) * 100;
                                updateUI(p);
                            });

                            video.addEventListener("play", () => {
                                window.progressTimer = setInterval(() => {
                                    const cur = Math.floor(video.currentTime);
                                    if (cur - lastSent >= 4) {
                                        lastSent = cur;
                                        sendProgress(cur);
                                    }
                                }, interval);
                            });

                            video.addEventListener("pause", () => {
                                clearInterval(window.progressTimer);
                                sendProgress(video.currentTime);
                            });

                            video.addEventListener("ended", () => {
                                clearInterval(window.progressTimer);
                                sendProgress(duration || video.currentTime);
                            });

                            video.addEventListener("seeked", () => {
                                lastSent = Math.floor(video.currentTime);
                                sendProgress(lastSent);
                            });

                            window.addEventListener("beforeunload", () => {
                                const cur = Math.floor(video.currentTime);
                                navigator.sendBeacon("/progress/update",
                                    new Blob([JSON.stringify({
                                        lesson_id: lessonId,
                                        watched_seconds: cur,
                                        duration_seconds: duration
                                    })], {type: "application/json"})
                                );
                            });
                        });
                    </script>

                {% elif lesson.content_type in ['pdf', 'document'] %}
                    <iframe src="{{ file_url }}" class="w-100"
                            style="height:800px; border:none; border-radius:10px;">
                    </iframe>

                    <p class="text-center mt-3">
                        <a href="{{ file_url }}" target="_blank" class="btn btn-info">
                            <i class="fas fa-external-link-alt"></i> Open / Download
                        </a>
                    </p>

                {% elif lesson.content_type in ['jpg','jpeg','png'] %}
                    <img src="{{ file_url }}" class="img-fluid rounded">

                {% elif lesson.content_type == 'text' %}
                    <div class="text-white-50" style="white-space: pre-line; font-size: 1.1rem;">
                        {{ lesson.content_text | safe }}
                    </div>

                {% else %}
                    <div class="alert alert-danger">Unsupported content type or missing file.</div>
                {% endif %}

            </div>
        </div>
    </div>
</div>
{% endblock %}
